<!DOCTYPE HTML>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title></title>

  
    <link rel="icon" href="global/favicon.ico"/>
  

  
    
      <link rel="stylesheet" href=".//css/font-awesome-4.4.0/css/font-awesome.min.css" type="text/css"/>
    
      <link rel="stylesheet" href=".//css/mermaid-6.0.0.css" type="text/css"/>
    
      <link rel="stylesheet" href=".//css/highlight/default.css" type="text/css"/>
    
      <link rel="stylesheet" href=".//css/showoff.css" type="text/css"/>
    
      <link rel="stylesheet" href=".//css/onepage.css" type="text/css"/>
    

    
      <link rel="stylesheet" href=".//file/netways.css" type="text/css"/>
    

    
      <script type="text/javascript" src=".//js/jquery-2.1.4.min.js"></script>
    
      <script type="text/javascript" src=".//js/showoff.js"></script>
    
      <script type="text/javascript" src=".//js/highlight.pack-9.2.0.js"></script>
    
      <script type="text/javascript" src=".//js/bigtext-0.1.8.js"></script>
    
      <script type="text/javascript" src=".//js/simpleStrings-0.0.1.js"></script>
    
      <script type="text/javascript" src=".//js/mermaid-6.0.0-min.js"></script>
    
    
    

  

  <script type="text/javascript">
    $(document).ready(function() {
      $('pre.highlight code').each(function(i, block) {
        try {
          // syntax highlight the code
          hljs.highlightBlock(block);

          // then add focus on any lines marked
          highlightLines(block);
        } catch(e) {
          console.log('Syntax highlighting failed on ' + $(this).closest('div.slide').attr('id'));
          console.log('Syntax highlighting failed for ' + $(this).attr('class'));
          console.log(e);
        }
      });


      // render diagrams and text manipulations unconditionally instead of waiting for slide views
      mermaid.init(undefined, $(".language-render-diagram"));
      $('.content.bigtext').bigtext();

      // translate SVG images, inlining them first if needed.
      user_translations = {
};
      $('img').simpleStrings({strings: user_translations});
      $('svg').simpleStrings({strings: user_translations});
      $('.translate').simpleStrings({strings: user_translations});
    });
  </script>

</head>

<body>
<div id="slides"class="supplemental" >
  <div data-section="sections/basics" data-title="03_installation" id="sections_basics_03_installation1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/basics/03_installation:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 2.1: Installation</h1>

<hr>

<h2>Install the Puppet agent provided by Puppet</h2>

<hr>

<h3>Make Puppet Collection available by installing the release repository</h3>

<pre><code>$ sudo yum install http://yum.puppet.com/puppet5/puppet5-release-el-7.noarch.rpm -y
</code></pre>

<h3>Inspect what version is installed on your master</h3>

<pre><code>$ sudo rpm -aq |grep puppet-agent
puppet-agent-x.y.z-n.el7.x86_64
</code></pre>

<h3>Install puppet-agent using yum</h3>

<pre><code>$ sudo yum install puppet-agent-x.y.z-n.el7.x86_64 -y
</code></pre>

<h3>Extend the secure path variable to include the puppet command</h3>

<pre><code>$ sudo visudo
Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/opt/puppetlabs/bin

$ exec bash
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/ral" data-title="07_command" id="sections_ral_07_command1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/ral/07_command:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 3.1: Puppet Resource</h1>

<hr>

<h2>Use Puppet Resource Command to query and change resources</h2>

<hr>

<h3>Query all users</h3>

<pre><code>$ sudo puppet resource user
</code></pre>

<h3>Query state of the file "/etc/passwd"</h3>

<pre><code>$ sudo puppet resource file /etc/passwd 
</code></pre>

<h3>Ensure package "vim-enhanced" is installed</h3>

<pre><code>$ sudo puppet resource package vim-enhanced ensure=present
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="03_users_groups" id="sections_resources_03_users_groups1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/03_users_groups:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.1: User</h1>

<h2>Create yourself a user</h2>

<hr>

<h3>Create a manifest "user.pp" to manage your user</h3>

<p>Change to the directory "manifests" and create "user.pp"</p>

<pre><code>$ cd ~/puppet/manifests/
$ vim user.pp
</code></pre>

<h3>Declare your user including its shell as "/bin/bash"</h3>

<p>Declare your user with your typically username, ensure that he is present
and set its shell to "/bin/bash"</p>

<pre><code>$ ~/puppet/manifests/user.pp
user { 'myuser':
  ensure =&gt; present,
  shell  =&gt; '/bin/bash',
}
</code></pre>

<h3>Set it to also manage your home directory</h3>

<p>Enforcing the user now would create your home directory depending on the default of your
operatingsystem, to enforce its creation set the attribute "managehome" to true.</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
user { 'myuser':
  ensure     =&gt; present,
  shell      =&gt; '/bin/bash',
  managehome =&gt; true,
}
</code></pre>

<h3>Apply the manifest with "puppet apply user.pp"</h3>

<p>Save the manifest and then use "puppet apply" to enforce it. Add "--noop" if you want to simulate
first, add "-d" if you want to see the commands executed. If you are not sure about the syntax run
the syntax validation before.</p>

<pre><code>$ puppet parser validate ~/puppet/manifests/user.pp
$ sudo puppet apply --noop ~/puppet/manifests/user.pp
$ sudo puppet apply -d ~/puppet/manifests/user.pp
</code></pre>

<p>To verify the user's existence you can use "id" or "getent", also verify the creation of the home directory
with "ls -la".</p>

<pre><code>$ sudo id myuser
$ sudo getent passwd myuser
$ sudo ls -la /home/myuser/
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="03_users_groups" id="sections_resources_03_users_groups2" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/03_users_groups:2">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.2: Group</h1>

<hr>

<h2>Manage the group membership of your user</h2>

<hr>

<h3>Add a group definition for your user's private group to your manifest (a group with the same name)</h3>

<p>Open your manifest user.pp and add a group resource.</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
group { 'myuser':
  ensure =&gt; present,
}
</code></pre>

<h3>Add a group definition for a administrative group "admins" to your manifest</h3>

<p>Add another group resource.</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
group { 'admins':
  ensure =&gt; present,
}
</code></pre>

<h3>Change your user definition to set its private group as its primary group and the administrative group as secondary</h3>

<p>Add the groups to your user definition</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
user { 'myuser':
  ensure     =&gt; present,
  shell      =&gt; '/bin/bash',
  gid        =&gt; 'myuser',
  groups     =&gt; [ 'admins' ],
  managehome =&gt; true,
}
</code></pre>

<h3>Apply the manifest with "puppet apply user.pp"</h3>

<p>Save the manifest and then use "puppet apply" to enforce it. Add "--noop" if you want to simulate
first, add "-d" if you want to see the commands executed.</p>

<pre><code>$ sudo puppet apply --noop ~/puppet/manifests/user.pp
$ sudo puppet apply -d ~/puppet/manifests/user.pp
</code></pre>

<p>To verify the user's group membership you can use "id".</p>

<pre><code>$ sudo id myuser
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="03_users_groups" id="sections_resources_03_users_groups3" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/03_users_groups:3">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.3: SSH Authorized Key</h1>

<hr>

<h2>Grant your user access to the system authenticated by a ssh key</h2>

<hr>

<h3>Generate a ssh key on your laptop using "ssh-keygen"</h3>

<p>Open a terminal on your laptop and execute "ssh-keygen". Keep the passphrase empty if you like.</p>

<pre><code>$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/training/.ssh/id_rsa): /home/training/.ssh/training_ssh
Created directory '/home/training/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/training/.ssh/training_ssh.
Your public key has been saved in /home/training/.ssh/training_ssh.pub.

$ cat ~/.ssh/training_ssh.pub
</code></pre>

<h3>Add a ssh_authorized_key resource to distribute your public key</h3>

<p>Add a ssh_authorized_key resource to distribute your public key. The first part of the output of
the command above is the type, the second one is the key itself and the third is the comment which
you are not required to keep.</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
ssh_authorized_key { 'myuser':
  ensure =&gt; present,
  type   =&gt; 'ssh-rsa',
  key    =&gt; '...',
  user   =&gt; 'myuser',
}
</code></pre>

<h3>Apply the manifest with "puppet apply user.pp"</h3>

<p>Save the manifest and then use "puppet apply" to enforce it. Add "--noop" if you want to simulate
first, add "-d" if you want to see the commands executed.</p>

<pre><code>$ sudo puppet apply --noop ~/puppet/manifests/user.pp
$ sudo puppet apply -d ~/puppet/manifests/user.pp
</code></pre>

<p>To verify the login try to connect to the virtual machine from your laptop.</p>

<pre><code>$ ssh myuser@agent-centos.localdomain
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="03_users_groups" id="sections_resources_03_users_groups4" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/03_users_groups:4">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.4: Sudoers</h1>

<hr>

<h2>Grant your user administrative privileges using sudo</h2>

<hr>

<h3>Ensure package "sudo" is installed</h3>

<p>Edit your manifest to include a definition ensuring the package "sudo" is installed.</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
package { 'sudo':
  ensure =&gt; present,
}
</code></pre>

<h3>Manage a file in "/etc/sudoers.d" for your user allow to execute all commands as root</h3>

<p>Add a file resource "/etc/sudoers.d/myuser" with owner "root", group "root", mode "0400" and content
"myuser ALL=(ALL) NOPASSWD: ALL".</p>

<pre><code>$ vim ~/puppet/manifests/user.pp
file { '/etc/sudoers.d/myuser': 
  ensure  =&gt; file,
  owner   =&gt; 'root',
  group   =&gt; 'root',
  mode    =&gt; '0400',
  content =&gt; "myuser ALL=(ALL) NOPASSWD: ALL\n",
}
</code></pre>

<h3>Apply the manifest with "puppet apply user.pp"</h3>

<p>Save the manifest and then use "puppet apply" to enforce it. Add "--noop" if you want to simulate
first, add "-d" if you want to see the commands executed.</p>

<pre><code>$ sudo puppet apply --noop ~/puppet/manifests/user.pp
$ sudo puppet apply -d ~/puppet/manifests/user.pp
</code></pre>

<p>You can verify the sudo permissions by displaying them with sudo or testing it as the user.</p>

<pre><code>$ sudo -U myuser -l

myuser$ sudo -l
myuser$ sudo id
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="04_ordering_relationship" id="sections_resources_04_ordering_relationship1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/04_ordering_relationship:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.5: Package-File-Service Pattern</h1>

<hr>

<h2>Install and run the Apache webserver</h2>

<hr>

<h3>Ensure package "httpd" is installed</h3>

<p>Create a new manifest "apache.pp" and declare a package resource "httpd" to be installed.</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp
package { 'httpd':
  ensure =&gt; present,
}
</code></pre>

<h3>Manage a configuration file "/etc/httpd/conf.d/local.conf"</h3>

<p>Add a new file to the "puppet/files" directory in your home directory as a source and then add a file resource managing
"/etc/httpd/conf.d/local.conf" to your manifest. To get the file install the apache package manually oder run the apply
command on your manifest before doing this step.</p>

<pre><code>$ vim ~/puppet/files/local.conf
ServerAdmin info@netways.de

$ vim ~/puppet/manifests/apache.pp
file { '/etc/httpd/conf.d/local.conf':
  ensure  =&gt; file,
  owner   =&gt; 'root',
  group   =&gt; 'root',
  mode    =&gt; '0644',
  source  =&gt; '/home/training/puppet/files/local.conf',
}
</code></pre>

<h3>Enable and start the service "httpd"</h3>

<p>Add a service resource which enables and starts "httpd".</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp
service { 'httpd':
  ensure    =&gt; running,
  enable    =&gt; true,
}
</code></pre>

<h3>Add dependencies to make sure it is installed before you configure it and config changes restart the service</h3>

<p>With Puppet 4's manifest based ordering the three resource would already be applied in correct order, but no refresh
would happen. Also understanding the code is easier if dependencies are explicitly declared.</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp
package { 'httpd':
  ...
}

file { '/etc/httpd/conf.d/local.conf':
  ...
  require =&gt; Package['httpd'],
}

service { 'httpd':
  ...
  subscribe =&gt; File['/etc/httpd/conf.d/local.conf'],
}
</code></pre>

<h3>Apply the manifest</h3>

<p>Save the manifest and then enforce it.</p>

<pre><code>$ sudo puppet apply ~/puppet/manifests/apache.pp
</code></pre>

<h3>Add the "Servername" to the configuration and apply again to see the service being restarted</h3>

<p>Open your copy of the configuration file and add the "Servername" directive, then apply again to if the service gets restarted
after changing its configuration.</p>

<pre><code>$ vim ~/puppet/files/local.conf
ServerName agent-centos.localdomain:80

$ sudo puppet apply ~/puppet/manifests/apache.pp
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="04_ordering_relationship" id="sections_resources_04_ordering_relationship2" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/04_ordering_relationship:2">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.6: Exec Resource</h1>

<hr>

<h2>Add an exec resource to change restart behaviour</h2>

<hr>

<h3>Add an exec resource to restart apache using systemctl</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
exec { 'apache-restart':
  command     =&gt; 'systemctl restart httpd',
  path        =&gt; '/usr/bin:/usr/sbin:/bin:/sbin',
  refreshonly =&gt; true,
}
</code></pre>

<h3>Change the service resource to reload instead of restart with a systemctl command in the restart attribute</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
service { 'httpd':
  ...
  #subscribe =&gt; File['/etc/httpd/conf.d/local.conf'],
  restart   =&gt; '/usr/bin/systemctl reload httpd',
}
</code></pre>

<h3>Change the file resource to notify the exec instead of the service</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
file { '/etc/httpd/conf.d/local.conf':
  ...
  require =&gt; Package['httpd'],
  notify  =&gt; Exec['apache-restart'],
}
</code></pre>

<h3>Apply the manifest</h3>

<p>Change something in the configuration file and apply the manifest.</p>

<pre><code>$ sudo puppet apply ~/puppet/manifests/apache.pp
</code></pre>

<p>Now you can decide in which cases a restart is required and when a reload is enough.</p>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="05_resource_defaults" id="sections_resources_05_resource_defaults1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/05_resource_defaults:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.7: Resource Defaults</h1>

<hr>

<h2>Add a vhost definition to your webserver</h2>

<hr>

<h3>Set the resource defaults for file resources to provide owner "root", group "root" and mode "0644"</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
File {
  owner =&gt; 'root',
  group =&gt; 'root',
  mode  =&gt; '0644',
}
</code></pre>

<h3>Add a host entry "vhost.localdomain" for your vhost on your server</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
host { 'vhost.localdomain':
  ensure       =&gt; present,
  ip           =&gt; '127.0.0.1',
  host_aliases =&gt; ['vhost'],
}
</code></pre>

<h3>Add a configuration file for your vhost creating a name based vhost</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
file { '/etc/httpd/conf.d/vhost.conf':
  ensure =&gt; file,
  source =&gt; '/home/training/puppet/files/vhost.conf',
}
$ vim ~/puppet/files/vhost.conf
&lt;VirtualHost *:80&gt;
    DocumentRoot "/var/www/vhost.localdomain"
    ServerName vhost.localdomain
&lt;/VirtualHost&gt;
</code></pre>

<h3>Create the document root "/var/www/vhost.localdomain" and an index file saying "Hello World"</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
file { '/var/www/vhost.localdomain/':
  ensure =&gt; directory,
}

file { '/var/www/vhost.localdomain/index.html':
  ensure =&gt; file,
  content =&gt; '&lt;h1&gt;Hello World&lt;/h1&gt;',
}
</code></pre>

<h3>Apply the manifest and restart the service</h3>

<pre><code>$ sudo puppet apply ~/puppet/manifests/vhost.pp
$ sudo service httpd reload
</code></pre>

<h3>Optional: Add an additional vhost for your default servername to provide different content based on the servername</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
file { '/etc/httpd/conf.d/default.conf':
  ensure =&gt; file,
  source =&gt; '/home/training/puppet/files/default.conf',
  notify =&gt; Service['httpd'],
}

$ vim ~/puppet/files/default.conf
&lt;VirtualHost *:80&gt;
    DocumentRoot "/var/www"
    ServerName agent-centos.localdomain
&lt;/VirtualHost&gt;

$ sudo puppet apply ~/puppet/manifests/apache.pp
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/resources" data-title="06_classes" id="sections_resources_06_classes1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/resources/06_classes:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 4.8: Classes</h1>

<hr>

<h2>Rework your apache manifest to provide a class apache</h2>

<hr>

<h3>Rework your apache manifest to provide a class apache</h3>

<p>Simply add the class definition around your Puppet code.</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp 
class apache {
  ...
}
</code></pre>

<h3>During apply have a look on what Puppet is actually doing</h3>

<p>Use the debug option to have a look on what Puppet is actually doing while you try to apply
your class definition. You will notice it is not managing your resources.</p>

<pre><code>$ sudo puppet apply --debug ~/puppet/manifests/apache.pp 
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="02_variables" id="sections_code_logic_02_variables1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/02_variables:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.1: Variables</h1>

<hr>

<h2>Rework your vhost manifest to include variables</h2>

<hr>

<h3>Add variables for hostname, fqdn, ip address of your vhost</h3>

<p>Because of the facts hostname, fqdn and ipaddress you can not use these names for your variables.</p>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
$shortname = 'vhost'
$fullname = "${shortname}.localdomain"
$ip = '127.0.0.1'
</code></pre>

<h3>Add variables for apache's configuration directory and your vhost's document root</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
$confdir = '/etc/httpd'
$documentroot = "/var/www/${fullname}"
</code></pre>

<h3>Incorporate the variables in your resource declarations</h3>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
host { $fullname:
  ip           =&gt; $ip,
  host_aliases =&gt; [ $shortname ],
}

file { "${confdir}/conf.d/${shortname}.conf":
  ensure =&gt; file,
  source =&gt; "/home/training/puppet/files/${shortname}.conf",
}

file { $documentroot:
  ensure =&gt; directory,
}

file { "${documentroot}/index.html":
  ensure  =&gt; file,
  content =&gt; '&lt;h1&gt;Hello World&lt;/h1&gt;',
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="03_conditionals" id="sections_code_logic_03_conditionals1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/03_conditionals:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.2: Case Statement</h1>

<hr>

<h2>Add Debian support to your apache manifest by using a case statement</h2>

<hr>

<h3>Move your package, config file and service name to variables</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
class apache {
  $packagename = 'httpd'
  $configdir   = '/etc/httpd'
  $localconfig  = "${configdir}/conf.d/local.conf"
  $servicename = 'httpd'
  ...
}
</code></pre>

<h3>Add the variables as value for the namevar of your resources</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
package { 'httpd':
  ...
  name =&gt; $packagename,
}

file { 'httpd local.conf':
  ...
  path =&gt; $localconfig,
}

service { 'httpd':
  ...
  name =&gt; $servicename,
}
</code></pre>

<h3>Add a case statement setting the variables depending on the "osfamily"</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
class apache {
  case $::osfamily {
    'RedHat': {
      $packagename = 'httpd'
      $configdir   = '/etc/httpd'
      $servicename = 'httpd'
    }
    'Debian': {
      $packagename = 'apache2'
      $configdir   = '/etc/apache2'
      $servicename = 'apache2'
    }
    default: {
      fail('Your platform is not supported')
    }
  }

  $confd  = "${configdir}/conf.d"
  $localconfig  = "${confd}/local.conf"
  ...
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="03_conditionals" id="sections_code_logic_03_conditionals2" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/03_conditionals:2">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.3: If Statement</h1>

<hr>

<h2>Allow to purge the Apache webserver</h2>

<hr>

<h3>Create a if statement based on a variable "$ensure" to set the state of your resources</h3>

<p>Add a variable "$ensure" to the top of your manifest and then set values corresponding
to the resource types. Explicitly requiring absent ensures the default is the more common
use case.</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp
class apache {
  $ensure = 'present'

  if $ensure == 'absent' {
    $ensure_package = 'purged'
    $ensure_file    = 'absent'
    $ensure_service = 'stopped'
    $enable_service = false
  } else {
    $ensure_package = 'present'
    $ensure_file    = 'file'
    $ensure_service = 'running'
    $enable_service = true
  }
  ...
}
</code></pre>

<h3>Use this variables in your resource declarations</h3>

<pre><code>$ vim ~/puppet/manifests/apache.pp
package { 'httpd':
  ensure =&gt; $ensure_package,
  ...
}

file { 'httpd local.conf':
  ensure =&gt; $ensure_file,
  ...
}

service { 'httpd':
  ensure =&gt; $ensure_service,
  enable =&gt; $enable_service,
  ...
}
</code></pre>

<div class="pagebreak">continued...</div>

<h3>Adjust the dependency chain based on "ensure" to bring also purging in correct order</h3>

<p>Adjusting the dependency chain based on the value of "ensure" is required that purge it completely
works fine. This is a very good example for the usage of the arrow syntax for declaring dependencies,
but not a typical example for common use in modules. In most public modules only small parts like
features will also have a deactivation routine.</p>

<pre><code>$ vim ~/puppet/manifests/apache.pp
file { 'httpd local.conf':
  ...
  #require =&gt; Package['httpd'],
}

if $ensure == "absent" {
  Service['httpd'] -&gt; File['httpd local.conf'] -&gt; Package['httpd']
} else {
  Package['httpd'] -&gt; File['httpd local.conf'] ~&gt; Service['httpd']
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="04_functions" id="sections_code_logic_04_functions1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/04_functions:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.4: ERB Template</h1>

<hr>

<h2>Move your vhost configuration to an erb template</h2>

<hr>

<h3>Create a erb template for your vhost by copying your static file and replace the values with erb</h3>

<p>The file extension .erb is not required but it enables syntax checking on templates based on it.</p>

<pre><code>$ cp ~/puppet/files/vhost.conf ~/puppet/templates/vhost.conf.erb

$ vim ~/puppet/templates/vhost.conf.erb
&lt;VirtualHost *:80&gt;
  DocumentRoot "&lt;%= @documentroot %&gt;"
  ServerName &lt;%= @fullname %&gt;
&lt;/VirtualHost&gt;
</code></pre>

<h3>Change the resource to use the template function for content instead of a static file as source</h3>

<p>Make sure to comment the source attribute because it is mutually exclusive with content.</p>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
file { "${confdir}/conf.d/${shortname}.conf":
  ensure  =&gt; file,
  #source =&gt; "/home/training/puppet/files/${shortname}.conf",
  content =&gt; template('/home/training/puppet/templates/vhost.conf.erb'),
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="04_functions" id="sections_code_logic_04_functions2" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/04_functions:2">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.5: EPP Template</h1>

<hr>

<h2>Create your webserver content from an epp template</h2>

<hr>

<h3>Create a epp template to represent your webserver content</h3>

<p>In this example both parameters get a default value for being optional. The greeting message must be a string
and falls back to "Hello World". The parameter from is per default undefined and can be this value or a string.</p>

<pre><code>$ vim ~/puppet/templates/index.html.epp
&lt;%- | String           $greeting = "Hello World",
      Optional[String] $from     = undef
| -%&gt;
&lt;h1&gt;&lt;%= $greeting %&gt; &lt;% unless $from =~ Undef { -%&gt; from &lt;%= $from %&gt;&lt;% } -%&gt;&lt;/h1&gt;
</code></pre>

<h3>Change the resource to use the template instead of fixed string</h3>

<p>This example defines only the from parameter and uses the default for the greeting message.</p>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
file { "${documentroot}/index.html":
  ensure   =&gt; file,
  #content =&gt; '&lt;h1&gt;Hello World&lt;/h1&gt;',
  content  =&gt; epp('/home/training/puppet/templates/index.html.epp', {
    'from' =&gt; "${fullname}"
  }),
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/code_logic" data-title="05_iteration" id="sections_code_logic_05_iteration1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/code_logic/05_iteration:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 5.6: Iteration</h1>

<hr>

<h2>Add multiple vhosts with an iteration</h2>

<hr>

<h3>Add a hash containing shortnames and ip addresses to the top of your manifest</h3>

<p>Add at least another vhost to this hash, simply use local ip addresses for this example.</p>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
$vhosts = {
  'vhost' =&gt; '127.0.0.1',
  'foo'   =&gt; '127.0.0.2',
  'bar'   =&gt; '127.0.0.3',
}
</code></pre>

<h3>Add an each loop based on this hash around your resources</h3>

<p>Iterate over the vhost hash with the each function to create your resources. Make sure
to not include your resource defaults in this loop.</p>

<pre><code>$ vim ~/puppet/manifests/vhost.pp
#$shortname = 'vhost'
#$fullname = "${shortname}.localdomain"
#$ip = '127.0.0.1'

#$confdir = '/etc/httpd'
#$documentroot = "/var/www/${fullname}"

$vhosts.each | $shortname, $ip | {
  $fullname = "${shortname}.localdomain"
  $confdir = '/etc/httpd'
  $documentroot = "/var/www/${fullname}"
...
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/modules" data-title="02_modules" id="sections_modules_02_modules1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/modules/02_modules:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 6.1: Module</h1>

<hr>

<h2>Build a module to handle your apache class</h2>

<hr>

<h3>Create the structure for your apache module in ~/puppet/modules</h3>

<p>It requires a directory apache with subdirectories manifests, files, templates and examples.
Make sure to use the plural, the most common mistake is using the singular which will prevent
autoloading from working.</p>

<pre><code>$ mkdir -p ~/puppet/modules/apache/{manifests,files,templates,examples}
</code></pre>

<h3>Move your manifest and all required files to this structure</h3>

<p>Move your class manifest to be your modules default class and your configuration file
to the location for static files.</p>

<pre><code>$ mv ~/puppet/manifests/apache.pp ~/puppet/modules/apache/manifests/init.pp
$ mv ~/puppet/files/local.conf ~/puppet/modules/apache/files/
</code></pre>

<h3>Adjust the source of your file resource</h3>

<p>Use the URL puppet:// to serve the configuration file. Note the URL starting with puppet:///
because of the omitted server. If no server is given the agent will load the file from the
server it contacted for requesting a catalog.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
file {'httpd local.conf':
  ...
  source  =&gt; 'puppet:///modules/apache/local.conf',
}
</code></pre>

<h3>Create a smoke test including your apache class</h3>

<p>Simple create a manifest using the include function on your apache class named like the
manifest defining it in the modules examples directory.</p>

<pre><code>$ vim ~/puppet/modules/apache/examples/init.pp
include apache
</code></pre>

<p>Now you can use apply on this file but you have to provide the modulepath.</p>

<pre><code>$ sudo puppet apply --debug --modulepath=~/puppet/modules/ ~/puppet/modules/apache/examples/init.pp
Debug: /Stage[main]/Apache/Package[httpd]/before: requires File[httpd local.conf]
Debug: /Stage[main]/Apache/File[httpd local.conf]/notify: subscribes to Service[httpd]
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/modules" data-title="03_parameterized_classes" id="sections_modules_03_parameterized_classes1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/modules/03_parameterized_classes:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 6.2: Parameterized Class</h1>

<hr>

<h2>Parameterize your apache class</h2>

<hr>

<h3>Promote the variable "$ensure" to be a parameter</h3>

<p>Change your class to provide a parameter "$ensure" which takes "running" and "stopped" with
a default of "running". And a Boolean parameter named "$enable" with a default to "true". Both
have to manage the service.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  Enum['running','stopped'] $ensure = 'running',
  Boolean                   $enable = true,
) {
  ...
  #$ensure = 'present'

  if $ensure == 'absent' {
    ...
    #$enable_service = false
  } else {
    ...
    #$enable_service = true
  }

  service { 'httpd':
    ensure =&gt; $ensure_service,
    enable =&gt; $enable,
  }
}
</code></pre>

<h3>Add a boolean parameter "$ssl" managing ssl support</h3>

<p>Add a boolean parameter "$ssl". Its default is "false", but if changed to "true" on CentOS
the package "mod_ssl" should be installed and the service "httpd" should be notified. You
can also handle the case of "absent" but package dependencies would be enough in this simple
setup.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  ...
  Boolean                   $ssl = false,
) {
  if $::osfamily == 'RedHat' {
    package { 'mod_ssl':
      ensure =&gt; $ssl ? {
        true    =&gt; installed,
        default =&gt; absent,
      }
    }
  }
  ...
}
</code></pre>

<div class="pagebreak">continued...</div>

<h3>Add a smoke test for running and to enable ssl</h3>

<p>Creating a smoke test allows you to validate your parameterized class.</p>

<pre><code>$ vim ~/puppet/modules/apache/examples/init_stopped.pp 
class { 'apache':
  ensure =&gt; stopped,
}

$ sudo puppet apply --modulepath ~/puppet/modules/ ~/puppet/modules/apache/examples/init_stopped.pp

$ vim ~/puppet/modules/apache/examples/init_ssl.pp 
class { 'apache':
  ssl =&gt; true,
}

$ sudo puppet apply --modulepath ~/puppet/modules/ ~/puppet/modules/apache/examples/init_ssl.pp
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/modules" data-title="04_inheritance" id="sections_modules_04_inheritance1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/modules/04_inheritance:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 6.3: Params.pp Pattern</h1>

<hr>

<h2>Create a params class providing your default parameters</h2>

<hr>

<h3>Create a params class providing your default parameters</h3>

<pre><code>$ vim ~/puppet/modules/apache/manifests/params.pp
class apache::params {
  case $::osfamily {
    'RedHat': {
      $packagename = 'httpd'
      $configdir   = '/etc/httpd'
      $confd       = "${configdir}/conf.d"
      $servicename = 'httpd'
      $ssl         =  true
    }
    'Debian': {
      $packagename = 'apache2'
      $configdir   = '/etc/apache2'
      $confd       = "${configdir}/conf.d"
      $servicename = 'apache2'
      $ssl         =  false
    }
    default: {
      fail('Your platform is not supported.')
    }
  }
}
</code></pre>

<h3>Remove the parameter calculation based on "$::osfamily" from your main class</h3>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  ...
) {
  #case $::osfamily {
  #  ...
  #}
  ...
}
</code></pre>

<h3>Inherit your params class and use its values as default</h3>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  Enum['running','stopped'] $ensure = 'running',
  Boolean           $enable = true,
  Boolean                   $ssl    = $apache::params::ssl,
) inherits apache::params {
  ...
}
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/modules" data-title="05_defined_resources" id="sections_modules_05_defined_resources1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/modules/05_defined_resources:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 6.4: Defined Resources</h1>

<hr>

<h2>Create a defined resource apache::vhost from your manifest</h2>

<hr>

<h3>Create a defined resource apache::vhost</h3>

<p>Create a defined resource apache::vhost based on your manifest. Use the
title for the shortname of your vhost.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/vhost.pp
define apache::vhost (
  String $ip,
  String $shortname    = $title,
  String $fullname     = "${shortname}.localdomain",
  String $confdir      = '/etc/httpd',
  String $documentroot = "/var/www/${fullname}",
) {
  ...
}
</code></pre>

<p>The ip address will be mandatory with this definition, all other have default
values and are optional because of this.</p>

<h3>Change the path of the templates from absolute to relative</h3>

<p>Copy the template files to the templates directory and change the path so the templates
are found through autoloading.</p>

<pre><code>$ cp -r ~/puppet/templates/ ~/puppet/modules/apache/
$ vim ~/puppet/modules/apache/manifests/vhost.pp
...
#content =&gt; template('/home/training/puppet/templates/vhost.conf.erb'),
content =&gt; template('apache/vhost.conf.erb'),
...
#content  =&gt; epp('/home/training/puppet/templates/index.html.epp', { 'from' =&gt; "${fullname}" }),
content  =&gt; epp('apache/index.html.epp', { 'from' =&gt; "${fullname}" }),
...
</code></pre>

<h3>Add a smoke test to apply multiple vhosts</h3>

<p>For testing defined resources always create a test declaring multiple
resources with different parameters to ensure included resources are
unique.</p>

<p>This example uses an iteration, but simply declaring multiple resources or
using create_resources would be fine.</p>

<pre><code> $ vim ~/puppet/modules/apache/examples/vhost.pp
 $vhosts = {
   'vhost' =&gt; { ip =&gt; '127.0.0.1'},
   'foo'   =&gt; { ip =&gt; '127.0.0.2'},
   'bar'   =&gt; { ip =&gt; '127.0.0.3', fullname =&gt; 'bar.example.com' },
   'baz'   =&gt; { ip =&gt; '127.0.0.4', documentroot =&gt; '/var/www/bazinga'},
 }

 $vhosts.each | String $name, Hash $vhost | {
   apache::vhost { $name :
     * =&gt; $vhost,
   }
 }
</code></pre>

<h3>Optional: Expand your defined resource to notify the service.</h3>

<p>Add a notify to your defined resource vhost to restart the service on changes to the vhost configuration.
This requires the smoke test to also include the main class.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/vhost.pp
file { "${confdir}/conf.d/$shortname.conf":
  ...
  notify =&gt; Service['httpd'],
}

$ vim ~/puppet/modules/apache/examples/vhost.pp
include apache
...
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/master" data-title="02_agent" id="sections_master_02_agent1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/master/02_agent:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 7.1: Communication</h1>

<hr>

<h2>Establish the communication between agent and master</h2>

<hr>

<h3>Configure the agent to connect to the master</h3>

<p>Set the server parameter in the agent section of the configuration <code>/etc/puppetlabs/puppet/puppet.conf</code></p>

<pre><code>$ sudo vim /etc/puppetlabs/puppet/puppet.conf
...
[agent]
server = puppet.localdomain
</code></pre>

<h3>Execute a puppet agent run</h3>

<p>On the first run it will inform you about creation of key and certificate request and that it
failed to retrieve certificate.</p>

<pre><code>$ sudo puppet agent -t
</code></pre>

<h3>Sign the certificate</h3>

<p>Login to the master and run the following command to sign the certificate.</p>

<pre><code>$ sudo puppet cert list
$ sudo puppet cert sign agent-centos.localdomain
</code></pre>

<h3>Execute another run</h3>

<p>On this run it will get the certificate and an empty catalog which applies without errors.</p>

<pre><code>$ sudo puppet agent -t
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/master" data-title="04_git_workflow" id="sections_master_04_git_workflow1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/master/04_git_workflow:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 7.2: Git Workflow</h1>

<hr>

<h2>Bring your puppet code under version control</h2>

<hr>

<h3>Use <code>git status</code> to find pending changes</h3>

<p>Git status will show you which files have changes no already commited which will be all files,
but it will only print to top most directory.</p>

<pre><code>$ git status
</code></pre>

<h3>Add them with <code>git add</code> to the staging area</h3>

<p>Run git add on the files printed.</p>

<pre><code>$ git add modules
</code></pre>

<h3>Create your initial commit using <code>git commit</code>
</h3>

<p>Running git commit will create a commit with all content of the staging area and ask you for a
commit message which you can also directly add with parameter -m.</p>

<pre><code>$ git commit -m "initial commit"
</code></pre>

<h3>Push it to the Puppet Master with <code>git push</code>
</h3>

<p>You should always tell git what exactly it should push if you do not want to accidently push
some local pending changes.</p>

<pre><code>$ git push origin master
</code></pre>

<p>In this case we only have one remote target named "origin" and only one branch "master". This
represents the "production" environment on the Puppet master.</p>

<p>If you get some error message from the validation hooks, fix them in the files, add them again
and create a new commit to push.</p>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/master" data-title="05_nodedeclaration" id="sections_master_05_nodedeclaration1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/master/05_nodedeclaration:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 7.3: Node Declaration</h1>

<hr>

<h2>Create a node declaration for your agent</h2>

<hr>

<h3>Create a node declaration for your agent 'agent-centos.localdomain'</h3>

<p>Add a node declaration to a manifest called site.pp for 'agent-centos.localdomain'
including apache.</p>

<pre><code>$ sudo vim ~/puppet/manifests/site.pp
node 'agent-centos.localdomain' {
  include apache
}
</code></pre>

<h3>Create a default node declaration printing a notice 'Node not configured'</h3>

<p>Add a default node declaration printing a notice 'Node not configured' which will be
printed if you run the agent with verbose or debug output. If you want it also included
in a report use a notify resource instead which will also a changed resource on every
run.</p>

<pre><code>$ sudo vim ~/puppet/manifests/site.pp
node default {
  notice('Node not configured')
}
</code></pre>

<h3>Commit and push it to your server</h3>

<p>Pushing the node declaration is required to use it.</p>

<pre><code>$ cd ~/puppet/
$ git add manifests/site.pp
$ git commit -m "adds default node declaration and agent-centos.localdomain"
$ git push origin master
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/master" data-title="06_hiera" id="sections_master_06_hiera1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/master/06_hiera:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 7.4: Environment Data</h1>

<hr>

<h2>Create a parameterized apache configuration using hiera</h2>

<hr>

<h3>Enable Hiera for environment data</h3>

<pre><code>$ vim ~/puppet/hiera.yaml
---
version: 5
defaults:
  datadir: data
  data_hash: yaml_data
hierarchy:
  - name: "Per-node data (yaml version)"
    path: "nodes/%{trusted.certname}.yaml"

  - name: "Other YAML hierarchy levels"
    paths:
      - "common.yaml"

$ mkdir -p ~/puppet/data/nodes
</code></pre>

<h3>Enable ssl per default</h3>

<pre><code>$ vim ~/puppet/data/common.yaml
---
apache::ssl: true
</code></pre>

<h3>Add a new parameter to accept a hash of vhosts</h3>

<p>Make also sure templates used in apache::vhost point to a relative path if not already
changed before.</p>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  ...
  Hash                     $vhosts      = {},
) inherits apache::params {
...
  $vhosts.each | String $name, Hash $vhost | {
    apache::vhost { $name :
      * =&gt; $vhost,
    }
  }
}
</code></pre>

<h3>Define the vhost hash for your client</h3>

<pre><code>$ vim data/nodes/agent-centos.localdomain.yaml
---
apache::vhosts:
  foobar:
    ip: 127.0.0.5
</code></pre>

<p>Do not forget to commit and push these changes before testing!</p>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/master" data-title="06_hiera" id="sections_master_06_hiera2" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/master/06_hiera:2">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 7.5: Params.pp pattern</h1>

<hr>

<h2>Move the params.pp pattern to data in modules</h2>

<hr>

<h3>Create a hiera config for your module</h3>

<pre><code>$ vim ~/puppet/modules/apache/hiera.yaml
---
version: 5

defaults:
  datadir: 'data'
  data_hash: 'yaml_data'

hierarchy:
  - name: 'Full Version'
    path: '%{facts.os.name}-%{facts.os.release.full}.yaml'

  - name: 'Major Version'
    path: '%{facts.os.name}-%{facts.os.release.major}.yaml'

  - name: 'Distribution Name'
    path: '%{facts.os.name}.yaml'

  - name: 'Operating System Family'
    path: '%{facts.os.family}-family.yaml'

  - name: 'common'
    path: 'common.yaml'
</code></pre>

<h3>Create hiera data for your supported operating systems</h3>

<pre><code>$ mkdir ~/puppet/modules/apache/data
$ vim ~/puppet/modules/apache/data/common.yaml
---
apache::ensure: 'stopped'
apache::enable: false
apache::package_name: 'httpd'
apache::config_dir: '~'
apache::main_config: '~/httpd.conf'
apache::conf_d: '~'
apache::service_name: 'httpd'
apache::ssl: false
$ vim ~/puppet/modules/apache/data/RedHat-family.yaml
---
apache::ensure: 'running'
apache::enable: true
apache::package_name: 'httpd'
apache::config_dir: '/etc/httpd'
apache::main_config: '/etc/httpd/conf/httpd.conf'
apache::conf_d: '/etc/httpd/conf.d'
apache::service_name: 'httpd'
apache::ssl: true
$ vim ~/puppet/modules/apache/data/Debian-family.yaml
---
apache::ensure: 'running'
apache::enable: true
apache::package_name: 'apache2'
apache::config_dir: '/etc/apache2'
apache::main_config: '/etc/apache2/apache2.conf'
apache::conf_d: '/etc/apache2/conf.d'
apache::service_name: 'apache2'
apache::ssl: false
</code></pre>

<h3>Adjust your base class</h3>

<pre><code>$ vim ~/puppet/modules/apache/manifests/init.pp
class apache (
  Enum['running','stopped'] $ensure,
  Boolean                   $enable,
  String                    $package_name,
  String                    $config_dir,
  String                    $main_config,
  String                    $conf_d,
  String                    $service_name,
  Boolean                   $ssl,
) {
...
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/forge" data-title="01_basics" id="sections_forge_01_basics1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/forge/01_basics:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 8.1: Forge</h1>

<hr>

<h2>Install the stdlib module provided by puppetlabs</h2>

<hr>

<h3>Search the Forge</h3>

<pre><code>$ puppet module search stdlib
</code></pre>

<h3>Install the module</h3>

<pre><code>$ puppet module install --modulepath ~/puppet/modules/ puppetlabs-stdlib
</code></pre>

<h3>List all installed modules</h3>

<pre><code>$ puppet module list --modulepath ~/puppet/modules/
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/forge" data-title="02_puppetdb" id="sections_forge_02_puppetdb1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/forge/02_puppetdb:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 8.2: PuppetDB</h1>

<hr>

<h2>Install PuppetDB using the Puppet module</h2>

<hr>

<h3>Install the PuppetDB module</h3>

<p>On the puppet master use the puppet module tool to install "puppetlabs-puppetdb" into environment <strong>master</strong>.</p>

<pre><code>$ sudo puppet module install puppetlabs-puppetdb --modulepath /etc/puppetlabs/code/environments/master/modules
</code></pre>

<h3>Assign it to your master</h3>

<p>Disable the module firewall management and bind it to your public ip address. The master is named "puppetmaster"
and we want to have reports stored in puppetdb.</p>

<pre><code>$ sudo vim /etc/puppetlabs/code/environments/master/manifests/site.pp
node 'puppet.localdomain' {
  class { 'puppetdb':
    manage_firewall =&gt; false,
    listen_address  =&gt; '192.168.56.101',
  }
  class { 'puppetdb::master::config':
    puppet_service_name     =&gt; 'puppetmaster',
    manage_report_processor =&gt; true,
    enable_reports          =&gt; true,
  }
}
</code></pre>

<p>Instead of typing all the configuration use the documentation of the module to copy most of it.</p>

<h3>Run the puppet agent to install it</h3>

<pre><code>$ sudo puppet agent -t
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>
<div data-section="sections/forge" data-title="03_puppetexplorer" id="sections_forge_03_puppetexplorer1" class="slide supplemental solutions" data-transition="none">
<div class="content supplemental solutions" ref="sections/forge/03_puppetexplorer:1">
<div class="net-header">
    <img src="./file///global/pre/netways/_images/Schulung_Stammlogo_2000px_ENG.jpg" alt="NETWAYS Training" width="215px" height="100px">
</div>

<h1>Lab 8.3: Puppet Explorer</h1>

<hr>

<h2>Install Puppet Explorer using the Puppet module</h2>

<hr>

<h3>Install the Puppet Explorer module</h3>

<p>On the puppet master use the puppet module tool to install "spotify-puppetexplorer" and "puppetlabs-apache" into
environment "master". The apache module is only an optional dependency so not automatically installed.</p>

<p><strong>Note:</strong> PuppetExplorer was first developed by the team at Spotify, and is now maintained by GitHub user "dalen".</p>

<pre><code>$ sudo puppet module install spotify-puppetexplorer -i /etc/puppetlabs/code/environments/master/modules
$ sudo puppet module install puppetlabs-apache -i /etc/puppetlabs/code/environments/master/modules
</code></pre>

<h3>Assign it to your master</h3>

<p>Puppet Explorer simply proxies the query issued to the PuppetDB using Apache. PuppetDB 4.x also introduced a breaking
change by moving some query location, compatibilty for this change can be restored by a rewrite rule (<a href="https://github.com/dalen/puppetexplorer/issues/49" target="_blank">https://github.com/dalen/puppetexplorer/issues/49</a>).</p>

<pre><code>$ sudo vim /etc/puppetlabs/code/environments/master/manifests/site.pp
node 'puppet.localdomain' {
  ...
  class { 'puppetexplorer':
    proxy_pass =&gt; [
      { 'path' =&gt; '/api/pdb/query', 'url' =&gt; 'http://192.168.56.101:8080/pdb/query' },
      { 'path' =&gt; '/api/pdb/meta', 'url' =&gt; 'http://192.168.56.101:8080/pdb/meta' },
      { 'path' =&gt; '/api/metrics', 'url' =&gt; 'http://192.168.56.101:8080/metrics' }
    ],
    vhost_options =&gt; {
      rewrites  =&gt; [ { rewrite_rule =&gt; ['^/api/metrics/v1/mbeans/puppetlabs.puppetdb.query.population:type=default,name=(.*)$  https://%{HTTP_HOST}/api/metrics/v1/mbeans/puppetlabs.puppetdb.population:name=$1 [R=301,L]'] } ],
    },
  }
}
</code></pre>

<p>Instead of typing all the configuration <strong>use the documentation of the module and the provided issue</strong> to copy most of it.</p>

<h3>Run the puppet agent to install it</h3>

<pre><code>$ sudo puppet agent -t
</code></pre>

<div class="net-footer">
    <p>Open Source Training</p>
    <p>by NETWAYS (netways.de)</p>
</div>
</div>
<canvas class="annotations"></canvas>
</div>

</div>
</body>
</html>
